<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>4x4 スライディングパズル＋スキル</title>
  <style>
    :root{
      --bg:#0f172a;
      --panel:#0b1220;
      --accent:#ffb86b;
      --tile:#1f2937;
      --tile-face:#f8fafc;
      --skill:#60a5fa;
    }
    html,body{height:100%;margin:0;font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;background:linear-gradient(180deg,#071023 0%, #07172a 60%);color:var(--tile-face);display:flex;align-items:center;justify-content:center;overflow:hidden}
    .container{width:min(720px,95vw);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:20px;box-shadow:0 10px 30px rgba(2,6,23,0.6);position:relative}
    header{display:flex;align-items:center;gap:16px;margin-bottom:12px}
    h1{font-size:1.25rem;margin:0}
    .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
    button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:var(--tile-face);cursor:pointer;transition:0.25s}
    button:hover{background:rgba(255,255,255,0.08)}
    button.primary{background:var(--accent);color:#101016;border:none}
    .board-wrap{display:grid;grid-template-columns:1fr 260px;gap:16px}
    @media (max-width:760px){.board-wrap{grid-template-columns:1fr}}
    .board{width:100%;aspect-ratio:1/1;background:linear-gradient(180deg,#071428, #0b1b2a);border-radius:12px;padding:8px;display:grid;grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(4,1fr);gap:8px;box-sizing:border-box;position:relative}
    .tile{display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.5rem;border-radius:8px;background:linear-gradient(180deg,#263244,#1a2a3a);box-shadow:inset 0 -6px 12px rgba(0,0,0,0.25);user-select:none;transition:transform .2s ease,opacity .2s ease;position:relative;z-index:1}
    .tile.move{animation:slide .25s ease forwards}
    .tile.empty{background:transparent;box-shadow:none;opacity:0}
    @keyframes slide{0%{transform:scale(1.2)}50%{transform:scale(0.9)}100%{transform:scale(1)}}
    .panel{background:linear-gradient(180deg,#07131b,#081623);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    .stats{display:flex;flex-direction:column;gap:8px}
    .stat-row{display:flex;justify-content:space-between;align-items:center;font-size:0.95rem}
    .hint{font-size:0.9rem;opacity:0.85}
    footer{margin-top:12px;font-size:0.85rem;opacity:0.8;text-align:right}
    .win-banner{position:fixed;left:50%;top:16px;transform:translateX(-50%);background:linear-gradient(90deg,#00b894,#00d6a1);color:#012;padding:10px 18px;border-radius:999px;box-shadow:0 8px 30px rgba(0,0,0,0.4);display:none;z-index:999}
    .skill-btn{background:var(--skill);color:#fff;font-weight:700;border:none;border-radius:6px;padding:6px 10px;margin-top:8px;cursor:pointer;width:100%;}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>4×4 スライディングパズル ✨</h1>
      <div class="controls">
        <button id="shuffleBtn">シャッフル</button>
        <button id="solveBtn">並び替え</button>
        <button id="hintBtn">ヒント</button>
      </div>
    </header>

    <div class="board-wrap">
      <div class="board panel" id="board"></div>
      <div class="panel">
        <div class="stats">
          <div class="stat-row"><span>移動数</span><strong id="moves">0</strong></div>
          <div class="stat-row"><span>経過時間</span><strong id="timer">00:00</strong></div>
          <div class="stat-row"><span>空きタイル位置</span><strong id="emptyPos">4,4</strong></div>
        </div>
        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)" />
        <div class="hint">矢印キーでも動かせます。</div>
        <button class="skill-btn" id="swapSkill">🔄 スワップスキル（2タイル入替）</button>
        <button class="skill-btn" id="revealSkill">💡 揃いスキル（1行自動揃え）</button>
      </div>
    </div>
    <footer>完成すると自動で判定します。</footer>
  </div>

  <div class="win-banner" id="winBanner">完成！おめでとう 🎉</div>

  <script>
    const SIZE = 4;
    const boardEl = document.getElementById('board');
    const movesEl = document.getElementById('moves');
    const timerEl = document.getElementById('timer');
    const emptyPosEl = document.getElementById('emptyPos');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const solveBtn = document.getElementById('solveBtn');
    const hintBtn = document.getElementById('hintBtn');
    const winBanner = document.getElementById('winBanner');
    const swapSkill = document.getElementById('swapSkill');
    const revealSkill = document.getElementById('revealSkill');

    let tiles = [], moves = 0, timer = null, startTime = null;
    let skillUsed = {swap:false, reveal:false};

    function initSolved(){ tiles = []; for(let i=1;i<SIZE*SIZE;i++) tiles.push(i); tiles.push(0); }

    function render(){
      boardEl.innerHTML = '';
      for(let i=0;i<tiles.length;i++){
        const val = tiles[i];
        const tile = document.createElement('div');
        tile.className = 'tile' + (val===0?' empty':'');
        if(val!==0) tile.textContent = val;
        tile.dataset.index = i;
        tile.addEventListener('click', ()=> tryMove(i));
        boardEl.appendChild(tile);
      }
      const emptyIdx = tiles.indexOf(0);
      emptyPosEl.textContent = `${Math.floor(emptyIdx/SIZE)+1},${emptyIdx%SIZE+1}`;
    }

    function isAdjacent(a,b){
      const ar=Math.floor(a/SIZE),ac=a%SIZE,br=Math.floor(b/SIZE),bc=b%SIZE;
      return Math.abs(ar-br)+Math.abs(ac-bc)===1;
    }

    function tryMove(index){
      const empty=tiles.indexOf(0);
      if(isAdjacent(index,empty)) move(index,empty);
    }

    function move(from,to){
      const tileEls=document.querySelectorAll('.tile');
      const tile=tileEls[from];
      tile.classList.add('move');
      tiles[to]=tiles[from];
      tiles[from]=0;
      moves++;
      movesEl.textContent=moves;
      render();
      checkWin();
    }

    function shuffle(){
      do{ tiles.sort(()=>Math.random()-0.5);}while(!isSolvable(tiles)||isSolvedArray(tiles));
      moves=0;movesEl.textContent=0;skillUsed={swap:false,reveal:false};startTimer();render();
    }

    function checkWin(){
      for(let i=0;i<tiles.length-1;i++) if(tiles[i]!==i+1) return;
      if(tiles[tiles.length-1]!==0)return;
      stopTimer();showWin();
    }

    function isSolvedArray(arr){ for(let i=0;i<arr.length-1;i++) if(arr[i]!==i+1) return false; return arr[arr.length-1]===0; }
    function isSolvable(arr){ const list=arr.filter(x=>x!==0); let inv=0; for(let i=0;i<list.length;i++){for(let j=i+1;j<list.length;j++){if(list[i]>list[j])inv++;}} const emptyRow=SIZE-Math.floor(arr.indexOf(0)/SIZE); return ((inv+emptyRow)%2)===0; }

    function startTimer(){stopTimer();startTime=Date.now();timer=setInterval(()=>{const e=Math.floor((Date.now()-startTime)/1000);const mm=String(Math.floor(e/60)).padStart(2,'0');const ss=String(e%60).padStart(2,'0');timerEl.textContent=`${mm}:${ss}`;},250);}
    function stopTimer(){if(timer){clearInterval(timer);timer=null;}}

    function showWin(){winBanner.style.display='block';setTimeout(()=>winBanner.style.display='none',4000);}

    // スキル: 2タイルをランダムスワップ
    swapSkill.addEventListener('click',()=>{
      if(skillUsed.swap) return alert('このスキルは1回だけ使えます！');
      let a,b; do{a=Math.floor(Math.random()*tiles.length);b=Math.floor(Math.random()*tiles.length);}while(a===b||tiles[a]===0||tiles[b]===0);
      [tiles[a],tiles[b]]=[tiles[b],tiles[a]];
      skillUsed.swap=true; render();
    });

    // スキル: 1行を自動揃え
    revealSkill.addEventListener('click',()=>{
      if(skillUsed.reveal) return alert('このスキルは1回だけ使えます！');
      const row=Math.floor(Math.random()*SIZE);
      for(let i=0;i<SIZE;i++){tiles[row*SIZE+i]=(row*SIZE+i+1)% (SIZE*SIZE);}
      skillUsed.reveal=true; render();
    });

    // キーボード操作
    window.addEventListener('keydown',e=>{
      const empty=tiles.indexOf(0);const r=Math.floor(empty/SIZE),c=empty%SIZE;let target=null;
      if(e.key==='ArrowUp'&&r<SIZE-1)target=(r+1)*SIZE+c;
      if(e.key==='ArrowDown'&&r>0)target=(r-1)*SIZE+c;
      if(e.key==='ArrowLeft'&&c<SIZE-1)target=r*SIZE+(c+1);
      if(e.key==='ArrowRight'&&c>0)target=r*SIZE+(c-1);
      if(target!==null){tryMove(target);e.preventDefault();}
    });

    shuffleBtn.addEventListener('click',shuffle);
    solveBtn.addEventListener('click',()=>{initSolved();render();stopTimer();});
    hintBtn.addEventListener('click',()=>{const e=tiles.indexOf(0);const n=[e-1,e+1,e-SIZE,e+SIZE].filter(i=>i>=0&&i<tiles.length&&isAdjacent(i,e));const hint=n[Math.floor(Math.random()*n.length)];const tileEl=document.querySelector(`.tile[data-index='${hint}']`);if(tileEl){tileEl.style.transform='scale(1.15)';setTimeout(()=>tileEl.style.transform='',350);}});

    initSolved();render();shuffle();
  </script>
</body>
</html>

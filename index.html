<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Ultimate FPS Game</title>
<style>
body{margin:0;overflow:hidden;background:#000;}
canvas{display:block;}
#score,#hp,#ammo,#weapon,#level{position:absolute;font-size:20px;color:white;}
#score{top:10px;left:10px;}
#hp{top:40px;left:10px;}
#ammo{top:70px;left:10px;}
#weapon{top:100px;left:10px;}
#level{top:130px;left:10px;}
#minimap{position:absolute;top:10px;right:10px;width:150px;height:150px;background:rgba(0,0,0,0.5);border:1px solid white;}
</style>
</head>
<body>
<div id="score">Score: 0</div>
<div id="hp">HP: 100</div>
<div id="ammo">Ammo: 20</div>
<div id="weapon">Weapon: Normal</div>
<div id="level">Level: 1</div>
<canvas id="minimap"></canvas>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/PointerLockControls.js"></script>
<script>
// --- 基本変数 ---
let scene,camera,renderer,controls;
let bullets=[],enemies=[],walls=[],items=[];
let score=0,hp=100,ammo=20,level=1;
let shooting=false,lastShotTime=0;
let fireRate=200,reloadTime=2000;
let weapon='normal';
const mazeSize=10, cellSize=2;
const miniCanvas=document.getElementById('minimap');
const miniCtx=miniCanvas.getContext('2d');

// --- 初期化 ---
init();
animate();

function init(){
scene=new THREE.Scene();
scene.background=new THREE.Color(0x87ceeb);
camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
camera.position.set(0,1.6,0);
renderer=new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth,window.innerHeight);
document.body.appendChild(renderer.domElement);

// 地面
const floor=new THREE.Mesh(
new THREE.PlaneGeometry(100,100),
new THREE.MeshPhongMaterial({color:0x228B22})
);
floor.rotation.x=-Math.PI/2;
scene.add(floor);

// 光源
const light=new THREE.DirectionalLight(0xffffff,1);
light.position.set(10,20,10);
scene.add(light);
scene.add(new THREE.AmbientLight(0x404040));

// FPSコントロール
controls=new THREE.PointerLockControls(camera,document.body);
document.body.addEventListener('click',()=>controls.lock());

// キー操作
const move={forward:false,backward:false,left:false,right:false};
document.addEventListener('keydown',(e)=>{
if(e.code==='KeyW') move.forward=true;
if(e.code==='KeyS') move.backward=true;
if(e.code==='KeyA') move.left=true;
if(e.code==='KeyD') move.right=true;
if(e.code==='KeyR') reload();
if(e.code==='Digit1'){weapon='normal'; fireRate=200; ammo=20; document.getElementById('weapon').textContent='Weapon: Normal'; document.getElementById('ammo').textContent='Ammo: '+ammo;}
if(e.code==='Digit2'){weapon='strong'; fireRate=500; ammo=5; document.getElementById('weapon').textContent='Weapon: Strong'; document.getElementById('ammo').textContent='Ammo: '+ammo;}
});
document.addEventListener('keyup',(e)=>{
if(e.code==='KeyW') move.forward=false;
if(e.code==='KeyS') move.backward=false;
if(e.code==='KeyA') move.left=false;
if(e.code==='KeyD') move.right=false;
});
document.addEventListener('mousedown',()=>shooting=true);
document.addEventListener('mouseup',()=>shooting=false);

// 初期迷路と敵
generateMaze(level);
spawnEnemies(level);
spawnItems(level);

// --- 移動 ---
function updateControls(){
const speed=0.1;
if(move.forward) controls.moveForward(speed);
if(move.backward) controls.moveForward(-speed);
if(move.left) controls.moveRight(-speed);
if(move.right) controls.moveRight(speed);
}

// --- 射撃 ---
function shootBullet(){
const now=Date.now();
if(now-lastShotTime<fireRate||ammo<=0) return;
lastShotTime=now;
ammo--;
document.getElementById('ammo').textContent='Ammo: '+ammo;

const bullet=new THREE.Mesh(
new THREE.SphereGeometry(0.1,8,8),
new THREE.MeshBasicMaterial({color:weapon==='normal'?0xff0000:0xffff00})
);
bullet.position.copy(camera.position);
const dir=new THREE.Vector3();
camera.getWorldDirection(dir);
bullet.userData={velocity:dir.clone().multiplyScalar(weapon==='normal'?2:3), owner:'player'};
scene.add(bullet);
bullets.push(bullet);

// 射撃音
const audio=new Audio('https://www.soundjay.com/mechanical/sounds/pistol-01.mp3');
audio.volume=0.2; audio.play();
}

// --- リロード ---
function reload(){
setTimeout(()=>{ammo=weapon==='normal'?20:5; document.getElementById('ammo').textContent='Ammo: '+ammo;},reloadTime);
}

// --- アニメーション ---
function animate(){
requestAnimationFrame(animate);
updateControls();

// 射撃
if(shooting) shootBullet();

// 弾処理
bullets.forEach((b,index)=>{
b.position.add(b.userData.velocity);

// 壁衝突
walls.forEach(w=>{
if(new THREE.Box3().setFromObject(w).containsPoint(b.position)){
scene.remove(b); bullets.splice(index,1);
}
});

// 敵衝突
if(b.userData.owner==='player'){
enemies.forEach((e,eIndex)=>{
if(new THREE.Box3().setFromObject(e.mesh).containsPoint(b.position)){
scene.remove(e.mesh);
enemies.splice(eIndex,1);
scene.remove(b); bullets.splice(index,1);
score+=10; document.getElementById('score').textContent='Score: '+score;
// ヒット音
const hitAudio=new Audio('https://www.soundjay.com/button/sounds/button-16.mp3');
hitAudio.volume=0.2; hitAudio.play();
// パーティクル
createParticles(e.mesh.position);
spawnEnemyRandom();
checkLevelUp();
}
});
}

// アイテム取得
items.forEach((it,i)=>{
if(camera.position.distanceTo(it.position)<1){
scene.remove(it); items.splice(i,1);
weapon='strong'; ammo=5; fireRate=500;
document.getElementById('weapon').textContent='Weapon: Strong';
document.getElementById('ammo').textContent='Ammo: '+ammo;
// アイテム取得音
const itemAudio=new Audio('https://www.soundjay.com/button/sounds/button-10.mp3');
itemAudio.volume=0.3; itemAudio.play();
}
});

// 敵の弾
if(b.userData.owner==='enemy'){
if(camera.position.distanceTo(b.position)<0.5){
hp-=5; if(hp<0) hp=0;
document.getElementById('hp').textContent='HP: '+Math.floor(hp);
scene.remove(b); bullets.splice(index,1);
if(hp===0){gameOver();}
}
}

if(b.position.length()>100){scene.remove(b); bullets.splice(index,1);}
});

// 敵AI
enemies.forEach(e=>{
if(e.type==='chase'){
const dir=new THREE.Vector3();
dir.subVectors(camera.position,e.mesh.position).setY(0).normalize();
e.mesh.position.add(dir.multiplyScalar(e.speed));
if(e.mesh.position.distanceTo(camera.position)<1){
hp-=0.5; if(hp<0) hp=0;
document.getElementById('hp').textContent='HP: '+Math.floor(hp);
if(hp===0){gameOver();}
}
}
if(e.type==='shoot'){
if(!e.cooldown) e.cooldown=0;
e.cooldown--;
if(e.cooldown<=0 && e.mesh.position.distanceTo(camera.position)<10){
const bullet=new THREE.Mesh(
new THREE.SphereGeometry(0.1,8,8),
new THREE.MeshBasicMaterial({color:0x00ffff})
);
bullet.position.copy(e.mesh.position);
const dir=new THREE.Vector3();
dir.subVectors(camera.position,e.mesh.position).normalize();
bullet.userData={velocity:dir.multiplyScalar(1.5), owner:'enemy'};
scene.add(bullet); bullets.push(bullet);
e.cooldown=100;
const audio=new Audio('https://www.soundjay.com/mechanical/sounds/pistol-01.mp3'); audio.volume=0.2; audio.play();
}
}
});

// ミニマップ
drawMiniMap();

renderer.render(scene,camera);
}

// --- パーティクル ---
function createParticles(pos){
for(let i=0;i<10;i++){
const part=new THREE.Mesh(new THREE.SphereGeometry(0.05,4,4), new THREE.MeshBasicMaterial({color:0xffff00}));
part.position.copy(pos);
const vel=new THREE.Vector3((Math.random()-0.5)*0.5,Math.random()*0.5,(Math.random()-0.5)*0.5);
part.userData={velocity:vel, life:30};
scene.add(part);
function update(){part.position.add(vel); part.userData.life--; if(part.userData.life<=0){scene.remove(part);}else{requestAnimationFrame(update);}}
update();
}
}

// --- 迷路生成 ---
function generateMaze(level){
walls.forEach(w=>scene.remove(w));
walls=[];
for(let i=0;i<mazeSize;i++){
for(let j=0;j<mazeSize;j++){
if(Math.random()<0.3+level*0.05){
const wall=new THREE.Mesh(
new THREE.BoxGeometry(cellSize,1,cellSize),
new THREE.MeshPhongMaterial({color:0x8B4513})
);
wall.position.set(j*cellSize-5,0.5,i*cellSize-5);
scene.add(wall); walls.push(wall);
}
}
}
}

// --- 敵生成 ---
function spawnEnemies(level){enemies=[]; for(let i=0;i<3+level;i++) spawnEnemyRandom();}
function spawnEnemyRandom(){
const type=Math.random()<0.7?'chase':'shoot';
const mesh=new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshPhongMaterial({color:type==='chase'?0xff00ff:0x00ffff}));
mesh.position.set(Math.random()*10-5,0.5,Math.random()*-10);
scene.add(mesh);
enemies.push({mesh:mesh,type:type,speed:type==='chase'?0.02:0,cooldown:0});
}

// --- アイテム生成 ---
function spawnItems(level){
items.forEach(it=>scene.remove(it)); items=[];
for(let i=0;i<level;i++){
const it=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5), new THREE.MeshPhongMaterial({color:0x00ff00}));
it.position.set(Math.random()*10-5,0.25,Math.random()*-10);
scene.add(it); items.push(it);
}
}

// --- ミニマップ ---
function drawMiniMap(){
miniCtx.clearRect(0,0,150,150);
miniCtx.fillStyle='white';
const px=(camera.position.x+10)/20*150;
const pz=(camera.position.z+10)/20*150;
miniCtx.fillRect(px,pz,5,5);
enemies.forEach(e=>{
miniCtx.fillStyle='red';
const ex=(e.mesh.position.x+10)/20*150;
const ez=(e.mesh.position.z+10)/20*150;
miniCtx.fillRect(ex,ez,5,5);
});
items.forEach(it=>{
miniCtx.fillStyle='lime';
const ix=(it.position.x+10)/20*150;
const iz=(it.position.z+10)/20*150;
miniCtx.fillRect(ix,iz,5,5);
});
}

// --- レベルアップ判定 ---
function checkLevelUp(){
if(score>=level*50){
level++; document.getElementById('level').textContent='Level: '+level;
generateMaze(level); spawnEnemies(level); spawnItems(level);
const audio=new Audio('https://www.soundjay.com/button/sounds/button-3.mp3'); audio.volume=0.3; audio.play();
}
}

// --- ゲームオーバー ---
function gameOver(){
alert('Game Over!'); score=0; hp=100; level=1; document.getElementById('score').textContent='Score: '+score; document.getElementById('hp').textContent='HP: '+hp; document.getElementById('level').textContent='Level: '+level; generateMaze(level); spawnEnemies(level); spawnItems(level);
}

window.addEventListener('resize',()=>{
camera.aspect=window.innerWidth/window.innerHeight;
camera.updateProjectionMatrix();
renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>
</body>
</html>

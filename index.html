<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>画像編集ツール</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 20px;
    }
    canvas {
      border: 1px solid #ccc;
      margin-top: 10px;
    }
    .controls {
      margin-top: 15px;
    }
    .controls label {
      display: inline-block;
      margin: 5px;
    }
  </style>
</head>
<body>

  <h1>画像編集ツール</h1>
  <input type="file" id="upload" accept="image/*"><br><br>

  <div class="controls">
    <label>明るさ: <input type="range" id="brightness" min="0" max="200" value="100"></label>
    <label>コントラスト: <input type="range" id="contrast" min="0" max="200" value="100"></label>
    <label>フィルター:
      <select id="filter">
        <option value="none">なし</option>
        <option value="grayscale">グレースケール</option>
        <option value="sepia">セピア</option>
      </select>
    </label>
    <br>
    <button onclick="rotateImage()">画像を90°回転</button>
    <button onclick="cropImage()">中央を切り抜き</button>
    <button onclick="downloadImage()">画像をダウンロード</button>
  </div>

  <canvas id="canvas"></canvas>

  <script>
    const upload = document.getElementById('upload');
    const brightnessSlider = document.getElementById('brightness');
    const contrastSlider = document.getElementById('contrast');
    const filterSelect = document.getElementById('filter');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let img = new Image();
    let originalImage = null;
    let currentAngle = 0;

    upload.addEventListener('change', function() {
      const file = upload.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        img.onload = function() {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          originalImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
          applyEffects();
        };
        img.src = e.target.result;
      };
      if (file) reader.readAsDataURL(file);
    });

    [brightnessSlider, contrastSlider, filterSelect].forEach(el => {
      el.addEventListener('input', applyEffects);
    });

    function applyEffects() {
      if (!originalImage) return;

      let imageData = new ImageData(
        new Uint8ClampedArray(originalImage.data),
        originalImage.width,
        originalImage.height
      );

      const brightness = brightnessSlider.value / 100;
      const contrast = contrastSlider.value / 100;
      const filter = filterSelect.value;

      for (let i = 0; i < imageData.data.length; i += 4) {
        let r = imageData.data[i];
        let g = imageData.data[i + 1];
        let b = imageData.data[i + 2];

        // 明るさ
        r = r * brightness;
        g = g * brightness;
        b = b * brightness;

        // コントラスト
        r = (r - 128) * contrast + 128;
        g = (g - 128) * contrast + 128;
        b = (b - 128) * contrast + 128;

        // フィルター
        if (filter === "grayscale") {
          let avg = (r + g + b) / 3;
          r = g = b = avg;
        } else if (filter === "sepia") {
          let tr = 0.393*r + 0.769*g + 0.189*b;
          let tg = 0.349*r + 0.686*g + 0.168*b;
          let tb = 0.272*r + 0.534*g + 0.131*b;
          r = tr;
          g = tg;
          b = tb;
        }

        imageData.data[i] = Math.min(255, Math.max(0, r));
        imageData.data[i + 1] = Math.min(255, Math.max(0, g));
        imageData.data[i + 2] = Math.min(255, Math.max(0, b));
      }

      canvas.width = originalImage.width;
      canvas.height = originalImage.height;
      ctx.putImageData(imageData, 0, 0);
    }

    function rotateImage() {
      if (!img.src) return;
      currentAngle = (currentAngle + 90) % 360;
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');

      if (currentAngle % 180 === 0) {
        tempCanvas.width = img.width;
        tempCanvas.height = img.height;
      } else {
        tempCanvas.width = img.height;
        tempCanvas.height = img.width;
      }

      tempCtx.translate(tempCanvas.width / 2, tempCanvas.height / 2);
      tempCtx.rotate(currentAngle * Math.PI / 180);
      tempCtx.drawImage(img, -img.width / 2, -img.height / 2);

      canvas.width = tempCanvas.width;
      canvas.height = tempCanvas.height;
      ctx.drawImage(tempCanvas, 0, 0);
      originalImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
      applyEffects();
    }

    function cropImage() {
      if (!originalImage) return;

      const cropWidth = originalImage.width / 2;
      const cropHeight = originalImage.height / 2;
      const x = (originalImage.width - cropWidth) / 2;
      const y = (originalImage.height - cropHeight) / 2;

      const cropped = ctx.getImageData(x, y, cropWidth, cropHeight);
      canvas.width = cropWidth;
      canvas.height = cropHeight;
      ctx.putImageData(cropped, 0, 0);

      originalImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
    }

    function downloadImage() {
      const link = document.createElement('a');
      link.download = 'edited-image.png';
      link.href = canvas.toDataURL();
      link.click();
    }
  </script>

</body>
</html>

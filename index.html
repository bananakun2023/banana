<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>È´òÂ∫¶„Å™Èü≥Ê•Ω‰ΩúÊàê„Çµ„Ç§„Éà</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #1e1e1e;
            color: white;
            margin: 0;
            padding: 0;
        }
        h1 {
            margin: 20px;
            color: #ffcc00;
        }
        .keyboard-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px;
        }
        .key {
            width: 60px;
            height: 200px;
            margin: 5px;
            background: white;
            border: 2px solid #000;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            cursor: pointer;
            color: black;
            font-weight: bold;
        }
        .key.black {
            width: 40px;
            height: 120px;
            background: black;
            color: white;
            position: relative;
            z-index: 1;
            margin-left: -20px;
            margin-right: -20px;
        }
        .key:active {
            background: #ffcc00;
        }
        .controls, .settings {
            margin-top: 20px;
        }
        button {
            background-color: #ffcc00;
            color: #1e1e1e;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #ffaa00;
        }
        select {
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #444;
            background: #333;
            color: white;
            font-size: 16px;
        }
        .visualizer {
            margin: 20px auto;
            width: 80%;
            height: 150px;
            background: black;
            border-radius: 5px;
            position: relative;
        }
    </style>
</head>
<body>

<h1>È´òÂ∫¶„Å™Èü≥Ê•Ω‰ΩúÊàê„Çµ„Ç§„Éà</h1>

<div class="settings">
    <label for="waveform">Èü≥Ëâ≤ÈÅ∏Êäû: </label>
    <select id="waveform">
        <option value="sine">„Çµ„Ç§„É≥Ê≥¢ (Piano)</option>
        <option value="square">„Çπ„ÇØ„Ç®„Ç¢Ê≥¢ (Synth)</option>
        <option value="triangle">‰∏âËßíÊ≥¢ (Bell)</option>
        <option value="sawtooth">„ÅÆ„Åì„Åé„ÇäÊ≥¢ (Strings)</option>
    </select>
</div>

<div class="keyboard-container">
    <div class="key" data-note="C">C</div>
    <div class="key black" data-note="C#">C#</div>
    <div class="key" data-note="D">D</div>
    <div class="key black" data-note="D#">D#</div>
    <div class="key" data-note="E">E</div>
    <div class="key" data-note="F">F</div>
    <div class="key black" data-note="F#">F#</div>
    <div class="key" data-note="G">G</div>
    <div class="key black" data-note="G#">G#</div>
    <div class="key" data-note="A">A</div>
    <div class="key black" data-note="A#">A#</div>
    <div class="key" data-note="B">B</div>
</div>

<div class="controls">
    <button onclick="startRecording()">üé§ Èå≤Èü≥ÈñãÂßã</button>
    <button onclick="stopRecording()">‚èπÔ∏è Èå≤Èü≥ÂÅúÊ≠¢</button>
    <button onclick="playRecording()">‚ñ∂Ô∏è ÂÜçÁîü</button>
</div>

<canvas id="visualizer" class="visualizer"></canvas>

<script>
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillators = {};
    const recording = [];
    let isRecording = false;
    const waveformSelect = document.getElementById('waveform');

    // Èü≥„ÅÆÂë®Ê≥¢Êï∞„Éû„ÉÉ„Éî„É≥„Ç∞
    const notes = {
        "C": 261.63,
        "C#": 277.18,
        "D": 293.66,
        "D#": 311.13,
        "E": 329.63,
        "F": 349.23,
        "F#": 369.99,
        "G": 392.00,
        "G#": 415.30,
        "A": 440.00,
        "A#": 466.16,
        "B": 493.88
    };

    // Èü≥„ÇíÂÜçÁîü
    function playNote(note) {
        if (!notes[note]) return;

        const osc = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        osc.type = waveformSelect.value; // ÈÅ∏Êäû„Åï„Çå„ÅüÈü≥Ëâ≤
        osc.frequency.value = notes[note];
        osc.connect(gainNode);
        gainNode.connect(audioContext.destination);

        osc.start();
        gainNode.gain.setValueAtTime(1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1);

        setTimeout(() => osc.stop(), 1000);

        // Èå≤Èü≥‰∏≠„Å™„ÇâË®òÈå≤
        if (isRecording) {
            recording.push({ note, time: audioContext.currentTime, waveform: waveformSelect.value });
        }
    }

    // Èå≤Èü≥ÈñãÂßã
    function startRecording() {
        recording.length = 0;
        isRecording = true;
        alert("Èå≤Èü≥„ÇíÈñãÂßã„Åó„Åæ„Åó„ÅüÔºÅ");
    }

    // Èå≤Èü≥ÂÅúÊ≠¢
    function stopRecording() {
        isRecording = false;
        alert("Èå≤Èü≥„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„ÅüÔºÅ");
    }

    // Èå≤Èü≥ÂÜçÁîü
    function playRecording() {
        if (recording.length === 0) {
            alert("Èå≤Èü≥„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„ÇìÔºÅ");
            return;
        }

        const startTime = recording[0].time;
        recording.forEach((entry) => {
            const delay = (entry.time - startTime) * 1000;
            setTimeout(() => {
                waveformSelect.value = entry.waveform; // Ê≥¢ÂΩ¢„ÇíÂÜçË®≠ÂÆö
                playNote(entry.note);
            }, delay);
        });
    }

    // „Ç≠„Éº„Éú„Éº„Éâ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
    document.querySelectorAll(".key").forEach(key => {
        key.addEventListener("mousedown", () => playNote(key.dataset.note));
    });

    // „Éì„Ç∏„É•„Ç¢„É©„Ç§„Ç∂„ÉºË®≠ÂÆö
    const canvas = document.getElementById('visualizer');
    const canvasContext = canvas.getContext('2d');
    const analyser = audioContext.createAnalyser();
    analyser.fftSize = 256;
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    const sourceNode = audioContext.createGain();
    sourceNode.connect(analyser);
    analyser.connect(audioContext.destination);

    canvas.width = window.innerWidth * 0.8;
    canvas.height = 150;

    function drawVisualizer() {
        requestAnimationFrame(drawVisualizer);

        analyser.getByteFrequencyData(dataArray);
        canvasContext.fillStyle = 'black';
        canvasContext.fillRect(0, 0, canvas.width, canvas.height);

        const barWidth = (canvas.width / bufferLength) * 2.5;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
            const barHeight = dataArray[i];
            canvasContext.fillStyle = `rgb(${barHeight + 100}, 50, 50)`;
            canvasContext.fillRect(x, canvas.height - barHeight / 2, barWidth, barHeight / 2);
            x += barWidth + 1;
        }
    }

    drawVisualizer();

    // MIDI„Çµ„Éù„Éº„Éà
    if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess().then(midiAccess => {
            midiAccess.inputs.forEach(input => {
                input.onmidimessage = (message) => {
                    const [type, note, velocity] = message.data;
                    if (type === 144 && velocity > 0) { // „Éé„Éº„Éà„Ç™„É≥
                        const noteName = Object.keys(notes)[note % 12];
                        playNote(noteName);
                    }
                };
            });
        });
    }
</script>

</body>
</html>
